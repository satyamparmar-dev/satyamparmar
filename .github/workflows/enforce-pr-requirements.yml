name: Enforce Pull Request Requirements

# DISABLED: Branch protection workflow is currently disabled to allow deployment and direct commits to main
# To re-enable: Uncomment the 'on:' section below and remove this comment block
# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# Workflow is disabled - no triggers active
on:
  workflow_dispatch:  # Allows manual trigger from GitHub Actions UI if needed

jobs:
  check-pr-requirements:
    runs-on: ubuntu-latest
    # DISABLED: Branch protection is disabled - change condition to enable
    if: false  # Change to 'github.event_name == "push" && github.ref == "refs/heads/main"' to enable
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check if commit is from PR merge
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      id: check-merge
      run: |
        # Check commit message for PR merge pattern
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        
        if [[ "$COMMIT_MSG" =~ ^Merge\ pull\ request ]]; then
          echo "âœ… PR merge detected (commit message: Merge pull request)"
          echo "is_pr_merge=true" >> $GITHUB_OUTPUT
        elif [[ "$COMMIT_MSG" =~ ^Merge\ branch ]]; then
          echo "âœ… Branch merge detected (likely from PR)"
          echo "is_pr_merge=true" >> $GITHUB_OUTPUT
        else
          # Check if commit has 2 parents (merge commit)
          COMMIT_PARENTS=$(git show --format="%P" --no-patch HEAD | wc -w)
          if [ "$COMMIT_PARENTS" -eq 2 ]; then
            echo "âœ… Merge commit detected (2 parents)"
            echo "is_pr_merge=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Direct commit detected"
            echo "is_pr_merge=false" >> $GITHUB_OUTPUT
          fi
        fi
    
    - name: Block direct commits
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check-merge.outputs.is_pr_merge == 'false'
      run: |
        echo "âŒ DIRECT COMMIT TO MAIN BRANCH DETECTED!"
        echo "ğŸš« This repository requires all changes to go through Pull Requests."
        echo ""
        echo "ğŸ“‹ Required Process:"
        echo "1. Create a feature branch: git checkout -b feature/your-feature-name"
        echo "2. Make your changes and commit them"
        echo "3. Push the branch: git push origin feature/your-feature-name"
        echo "4. Create a Pull Request on GitHub"
        echo "5. Get at least 1 approval from a reviewer"
        echo "6. Merge through the PR interface"
        echo ""
        echo "ğŸ”’ Security: This prevents accidental commits and ensures code review."
        echo "ğŸ“Š Current commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Committer: ${{ github.event.head_commit.committer.name }}"
        echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"
        echo ""
        echo "âŒ This workflow will fail to prevent the commit."
        exit 1
    
    - name: Allow PR merge
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.check-merge.outputs.is_pr_merge == 'true'
      run: |
        echo "âœ… PR merge detected - allowing commit"
        echo "ğŸ“Š Commit: ${{ github.sha }}"
        echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"

  validate-pr:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linting
      run: npm run lint
    
    - name: Type check
      run: npx tsc --noEmit
    
    - name: Build check
      run: npm run build
    
    - name: Check PR requirements
      run: |
        echo "âœ… Pull Request validation passed!"
        echo "ğŸ“‹ PR Requirements:"
        echo "- âœ… Code builds successfully"
        echo "- âœ… Linting passes"
        echo "- âœ… Type checking passes"
        echo "- â³ Waiting for approval..."
        echo ""
        echo "ğŸ”’ This PR requires at least 1 approval before merging."
        echo "ğŸ‘¥ Please request a review from a team member."

  block-direct-commits:
    runs-on: ubuntu-latest
    # DISABLED: Branch protection is disabled - change condition to enable
    if: false  # Change to 'github.event_name == "push" && github.ref == "refs/heads/main"' to enable
    
    steps:
    - name: Block direct commits
      run: |
        echo "ğŸ›¡ï¸  BRANCH PROTECTION ACTIVATED"
        echo ""
        echo "This repository enforces the following rules:"
        echo "1. âŒ No direct commits to main branch"
        echo "2. âœ… All changes must go through Pull Requests"
        echo "3. âœ… All PRs must be approved before merging"
        echo "4. âœ… All PRs must pass CI checks"
        echo ""
        echo "Current commit has been blocked for security."
        exit 1
